# vim:ft=sh

export ZSH="$ZDOTDIR/ohmyzsh"
export ZSH_CUSTOM="$ZDOTDIR/ohmyzsh-custom"

ZSH_THEME="mass"
DISABLE_FZF_KEY_BINDINGS="true"

# Must define git aliases before initializing omz so that chezmoi plugin will detect them
alias gaf="git ls-files --modified --others --exclude-standard | fzf --print0 --multi | xargs -0 -t git add"

plugins=(
  # Quality of life
  direnv
  zsh-syntax-highlighting
  zsh-autosuggestions
  you-should-use
  vi-mode
  virtualenv
  # Utilities
  git
  chezmoi
  fzf
  # Languages
  golang
  rust
  pulumi
)

# Conditionally add ssh-agent if not already set up
if [[ -z $SSH_AUTH_SOCK ]]; then
  if (( $+commands[socat] )) && (( $+commands[npiperelay.exe] )); then
    export SSH_AUTH_SOCK="$HOME/.ssh/agent/npiperelay.sock"
    rm -f $SSH_AUTH_SOCK
    ( setsid socat UNIX-LISTEN:$SSH_AUTH_SOCK,fork EXEC:"npiperelay.exe -ei -s //./pipe/openssh-ssh-agent",nofork & ) >/dev/null 2>&1
  elif (( $+commands[bitwarden-desktop] )); then
    export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
  else
    zstyle :omz:plugins:ssh-agent lazy yes
    plugins+=('ssh-agent')
  fi
fi

. $ZSH/oh-my-zsh.sh

for file in $ZDOTDIR/alias/*; do
  . $file
done

# Change fzf keybind
bindkey -r '^T'
bindkey '^F' fzf-file-widget

[ -f "$ZDOTDIR/.zshrc.local" ] && . "$ZDOTDIR/.zshrc.local"
